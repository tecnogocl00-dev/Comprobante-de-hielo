<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprobante ICE KING</title>
    <!-- Configuraci√≥n PWA (Manifiesto) -->
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#06B6D4">
    
    <!-- Carga de Tailwind CSS para estilos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#1D4ED8',
                        'secondary-gray': '#F3F4F6',
                        'ice-blue': '#BFDBFE',
                        'brand-color': '#06B6D4', /* Nuevo color para ICE KING */
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* Estilos personalizados para la tipograf√≠a y el espaciado en m√≥viles */
        body {
            background-color: #E5E7EB; /* Fondo suave */
            font-family: 'Inter', sans-serif;
            padding: 1rem;
        }
        /* Estilo para simular el comprobante impreso o digital */
        .receipt-card {
            border: 3px solid #06B6D4; /* Borde m√°s llamativo con el color de la marca */
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
            background-color: white;
            padding: 2rem;
            padding-bottom: 1.5rem; /* Reducido a 1.5rem para compresi√≥n vertical */
            margin-top: 1.5rem;
            transform: scale(1); /* Asegura que la captura se vea bien */
        }
        /* Estilo para la animaci√≥n del bot√≥n de descarga */
        .download-button:hover {
            animation: pulse-shadow 1s infinite;
        }
        @keyframes pulse-shadow {
            0% { box-shadow: 0 0 0 0 rgba(6, 182, 212, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(6, 182, 212, 0); }
            100% { box-shadow: 0 0 0 0 rgba(6, 182, 212, 0); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center">

    <!-- Contenedor Principal y Panel de Entrada (Ancho ajustado a md) -->
    <div class="w-full max-w-md mx-auto p-4 bg-white rounded-xl shadow-lg border border-gray-200">
        <h1 class="text-xl font-bold text-center text-brand-color mb-4">üßä ICE KING - Generador de Boletas</h1>

        <!-- Campo de Kilos -->
        <div class="mb-3">
            <label for="kilosInput" class="block text-sm font-medium text-gray-700 mb-1">
                1. Kilos de Hielo a Vender
            </label>
            <input type="number" id="kilosInput" placeholder="Solo n√∫meros enteros" min="1" step="1" 
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-brand-color focus:border-brand-color transition duration-150"
                   value="1">
            <p id="error-message" class="text-red-500 text-xs mt-1 hidden">Por favor, ingrese una cantidad v√°lida (solo n√∫meros enteros positivos).</p>
        </div>

        <!-- Campo de Fecha (Nuevo) -->
        <div class="mb-5">
            <label for="dateInput" class="block text-sm font-medium text-gray-700 mb-1">
                2. Fecha del Comprobante
            </label>
            <input type="date" id="dateInput" 
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-brand-color focus:border-brand-color transition duration-150">
        </div>
        
        <!-- Bot√≥n de Generaci√≥n -->
        <button onclick="generateReceipt()"
                class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg transition duration-200 shadow-lg transform hover:scale-[1.02] active:scale-[0.98]">
            3. Generar Comprobante
        </button>
    </div>

    <!-- √Årea del Comprobante (Dise√±ada para ser capturada/screenshot - Ancho ajustado a md) -->
    <div id="receiptContainer" class="hidden w-full max-w-md mx-auto receipt-card mt-6">
        <!-- El contenido ser√° insertado aqu√≠ por JavaScript -->
    </div>
    
    <!-- Botones de Descarga (Ancho ajustado a md) -->
    <div id="downloadArea" class="hidden w-full max-w-md mx-auto mt-4 space-y-3 sm:space-y-0 sm:flex sm:gap-3">
        <button id="downloadButtonPng" onclick="downloadReceiptImage()"
                class="download-button w-full sm:flex-1 bg-brand-color hover:bg-cyan-600 text-white font-bold py-3 rounded-xl transition duration-300 shadow-xl border-b-4 border-cyan-700">
            ‚¨áÔ∏è Descargar Imagen (Optimizado WhatsApp)
        </button>
        <button id="downloadButtonPdf" onclick="downloadReceiptPdf()"
                class="download-button w-full sm:flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-xl transition duration-300 shadow-xl border-b-4 border-red-800">
            ‚¨áÔ∏è Descargar PDF
        </button>
    </div>

    <!-- Carga de las librer√≠as al final del body para la m√°xima estabilidad de carga -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script type="text/javascript">
        // Constantes del negocio (Precio y Datos de Transferencia)
        const PRICE_PER_KILO = 400; // Valor del kilo de hielo en CLP
        const ACCOUNT_DETAILS = {
            name: "Geraldine Abarza Hern√°ndez",
            rut: "18.763.476-8",
            type: "Cuenta RUT"
        };
        const CURRENCY_FORMAT = new Intl.NumberFormat('es-CL', {
            style: 'currency',
            currency: 'CLP',
            minimumFractionDigits: 0
        });

        // Funci√≥n de inicializaci√≥n
        function initApp() {
            try {
                const dateInput = document.getElementById('dateInput');
                const today = new Date().toISOString().split('T')[0];
                dateInput.value = today;
                generateReceipt(); // Generar un comprobante inicial
            } catch (error) {
                console.error("Error cr√≠tico en la inicializaci√≥n:", error);
                // Si hay un error, al menos mostramos un mensaje en el √°rea de descarga.
                const downloadArea = document.getElementById('downloadArea');
                if (downloadArea) {
                    downloadArea.innerHTML = '<p class="text-red-600 text-center font-bold">Error al iniciar la aplicaci√≥n. Revise su conexi√≥n o entorno.</p>';
                    downloadArea.classList.remove('hidden');
                }
            }
        }

        // Ejecutar la inicializaci√≥n una vez que el DOM est√© completamente cargado.
        document.addEventListener('DOMContentLoaded', initApp);

        // =========================================================================
        // NOTA IMPORTANTE: Se ha comentado el registro del Service Worker (PWA)
        // para solucionar el conflicto de carga que dejaba la p√°gina en blanco.
        // La funcionalidad de descarga tiene prioridad.
        // =========================================================================
        /*
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js', { scope: '/' })
                    .then(registration => {
                        console.log('Service Worker registrado con √©xito:', registration);
                    })
                    .catch(error => {
                        console.error('Fallo en el registro del Service Worker:', error);
                    });
            });
        }
        */
        // =========================================================================


        /**
         * Funci√≥n principal para calcular el total y generar el HTML del comprobante.
         */
        function generateReceipt() {
            const inputElement = document.getElementById('kilosInput');
            const dateInput = document.getElementById('dateInput');
            const errorMessage = document.getElementById('error-message');
            const receiptContainer = document.getElementById('receiptContainer');
            const downloadArea = document.getElementById('downloadArea');
            
            // Limpiar errores previos
            errorMessage.classList.add('hidden');
            inputElement.classList.remove('border-red-500');

            const kilos = parseInt(inputElement.value, 10);
            const selectedDate = dateInput.value;

            // Validaci√≥n de entrada
            if (isNaN(kilos) || kilos <= 0) {
                errorMessage.textContent = "Por favor, ingrese una cantidad v√°lida de kilos (solo n√∫meros enteros positivos).";
                errorMessage.classList.remove('hidden');
                inputElement.classList.add('border-red-500');
                receiptContainer.classList.add('hidden');
                downloadArea.classList.add('hidden');
                return;
            }

            // 1. C√°lculo del total
            const totalAmount = kilos * PRICE_PER_KILO;

            // 2. Formateo de la fecha (sin hora ni folio)
            let dateStr = 'Fecha no definida';
            if (selectedDate) {
                const parts = selectedDate.split('-'); // [YYYY, MM, DD]
                const dateObj = new Date(parts[0], parts[1] - 1, parts[2]);
                dateStr = dateObj.toLocaleDateString('es-CL', { 
                    year: 'numeric', month: 'long', day: 'numeric' 
                });
            }

            // 3. Generaci√≥n del contenido HTML del comprobante
            receiptContainer.innerHTML = `
                <!-- Encabezado del Comprobante (Ajuste para sobresalir) -->
                <div class="text-center pb-2 border-b-4 border-double border-brand-color">
                    <!-- T√≠tulo del comprobante ajustado a text-sm -->
                    <p class="text-sm font-semibold text-gray-500">COMPROBANTE DE VENTA</p>
                    <h2 class="text-5xl font-black text-brand-color">üßä ICE KING</h2>
                    <p class="text-sm font-semibold text-gray-600 mt-0.5">
                        Fecha: <span class="text-gray-900">${dateStr}</span>
                    </p>
                </div>

                <!-- Detalles de la Transacci√≥n -->
                <div class="py-2 border-b border-dashed border-gray-300">
                    <p class="flex justify-between font-semibold text-xl mb-1">
                        <span>Descripci√≥n</span>
                        <span>Total</span>
                    </p>
                    <div class="flex justify-between text-gray-700 border-t pt-1 border-gray-100">
                        <span class="text-lg font-medium text-gray-600">${kilos} Kilos de Hielo</span>
                        <span class="text-2xl font-bold">${CURRENCY_FORMAT.format(totalAmount)}</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-1 text-right">
                        Precio Unitario: ${CURRENCY_FORMAT.format(PRICE_PER_KILO)} por kilo.
                    </p>
                </div>
                
                <!-- Total a Pagar -->
                <div class="pt-3 flex justify-between items-center bg-ice-blue rounded-lg p-3">
                    <span class="text-2xl font-bold text-gray-800">TOTAL A PAGAR</span>
                    <span class="text-5xl font-extrabold text-green-700">${CURRENCY_FORMAT.format(totalAmount)}</span>
                </div>

                <!-- Recordatorio de Datos de Transferencia y de Env√≠o del Comprobante (Dirigido al Cliente) -->
                <div class="mt-3 p-3 bg-secondary-gray rounded-xl border border-gray-300">
                    <h3 class="text-xl font-bold text-primary-blue mb-2 border-b pb-1 flex items-center">
                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
                        Datos para Transferencia
                    </h3>
                    <div class="space-y-1 text-base text-gray-700">
                        <p>
                            <span class="font-semibold">Nombre:</span> ${ACCOUNT_DETAILS.name}
                        </p>
                        <p>
                            <span class="font-semibold">RUT:</span> ${ACCOUNT_DETAILS.rut}
                        </p>
                        <p>
                            <span class="font-semibold">Tipo de Cuenta:</span> ${ACCOUNT_DETAILS.type}
                        </p>
                    </div>

                    <!-- Recordatorio de ENV√çO AL CLIENTE -->
                    <div class="mt-3 p-3 bg-yellow-100 rounded-lg border border-yellow-300 text-center">
                        <p class="text-base font-extrabold text-yellow-800">
                            ¬°IMPORTANTE!
                        </p>
                        <p class="text-base font-semibold text-gray-800">
                            Tras realizar la transferencia, por favor, env√≠e su comprobante de pago a trav√©s de WhatsApp.
                        </p>
                    </div>

                </div>
                
                <!-- Pie de p√°gina -->
                <p class="text-center text-xs text-gray-500 mt-2 pt-2 border-t border-gray-200">
                    ¬°Gracias por preferir ICE KING! ‚ùÑÔ∏è
                </p>
            `;

            // Mostrar el contenedor del recibo y el √°rea de descarga
            receiptContainer.classList.remove('hidden');
            downloadArea.classList.remove('hidden');
        }

        /**
         * Funci√≥n central para generar el canvas (imagen) del comprobante.
         * Aplica un buffer para evitar recortes en la captura.
         */
        async function getReceiptCanvas() {
            const receiptContainer = document.getElementById('receiptContainer');
            const receiptWidth = receiptContainer.offsetWidth;
            
            // Buffer de seguridad. AJUSTADO a 30px seg√∫n la √∫ltima solicitud.
            const heightBuffer = 30; 
            const receiptHeightWithBuffer = receiptContainer.offsetHeight + heightBuffer;

            return await html2canvas(receiptContainer, {
                scale: 3, 
                useCORS: true, 
                backgroundColor: '#FFFFFF',
                // Forzamos las dimensiones de captura con el buffer
                width: receiptWidth,
                height: receiptHeightWithBuffer,
                scrollY: 0, 
                scrollX: 0 
            });
        }

        /**
         * Descarga la imagen del comprobante usando html2canvas (PNG).
         * SOLUCI√ìN WHATSAPP: El comprobante se centra en un lienzo optimizado (rectangular ancho) para maximizar el tama√±o en la previsualizaci√≥n.
         */
        async function downloadReceiptImage() {
            const downloadButton = document.getElementById('downloadButtonPng');
            
            const originalText = downloadButton.innerHTML;
            downloadButton.disabled = true;
            downloadButton.innerHTML = 'Generando Imagen Optimizado...';

            try {
                if (typeof html2canvas === 'undefined') throw new Error("html2canvas no est√° cargado.");
                
                // 1. Obtener el canvas de la boleta (alto y estrecho)
                const receiptCanvas = await getReceiptCanvas();

                const receiptWidth = receiptCanvas.width;
                const receiptHeight = receiptCanvas.height;
                
                // 2. Determinar las dimensiones del lienzo OPTIMIZADO:
                // Factor ajustado a 1.05 (solo 5% de margen lateral) ya que el nuevo dise√±o es m√°s ancho.
                const optimizationFactor = 1.05;
                const finalWidth = receiptWidth * optimizationFactor;
                const finalHeight = receiptHeight; // Mantenemos la altura exacta de la boleta.
                
                // 3. Crear el lienzo final (el que se descargar√°)
                const finalCanvas = document.createElement('canvas');
                finalCanvas.width = finalWidth;
                finalCanvas.height = finalHeight;
                const ctx = finalCanvas.getContext('2d');

                // 4. Llenar el fondo del lienzo final de color blanco
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, finalWidth, finalHeight);

                // 5. Calcular la posici√≥n para centrar la boleta horizontalmente
                // x-offset = (Ancho final - Ancho de la boleta) / 2
                const offsetX = (finalWidth - receiptWidth) / 2;
                
                // 6. Dibujar el canvas de la boleta en el centro del lienzo final
                ctx.drawImage(receiptCanvas, offsetX, 0); // Y-offset es 0 porque la altura es la misma.

                // 7. Convertir el lienzo final a URL de imagen
                const image = finalCanvas.toDataURL('image/png');
                
                // 8. Crear un elemento 'a' temporal para la descarga
                const link = document.createElement('a');
                link.href = image;
                
                // Definir el nombre del archivo de descarga
                const kilos = document.getElementById('kilosInput').value || '0';
                const dateStr = document.getElementById('dateInput').value;
                link.download = `Comprobante_ICEKING_WP_${kilos}Kg_${dateStr}.png`;
                
                // 9. Iniciar la descarga
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

            } catch (error) {
                console.error("Error al generar la imagen optimizada:", error);
                // Si hay un error, informamos al usuario restaurando el bot√≥n con un mensaje de fallo.
                downloadButton.innerHTML = '‚ùå Error al Descargar. Intente de Nuevo';
                setTimeout(() => {
                    downloadButton.innerHTML = originalText;
                    downloadButton.disabled = false;
                }, 3000);
                return; // Salir de la funci√≥n despu√©s del error
            } finally {
                // Restaurar el bot√≥n si no hubo un error
                if (downloadButton.innerHTML.indexOf('Error') === -1) {
                    downloadButton.innerHTML = originalText;
                    downloadButton.disabled = false;
                }
            }
        }

        /**
         * Descarga el comprobante como un documento PDF usando el canvas previamente generado.
         * Usa tama√±o de p√°gina din√°mico y compensaci√≥n de buffer para m√°rgenes uniformes.
         */
        async function downloadReceiptPdf() {
            const receiptContainer = document.getElementById('receiptContainer');
            const downloadButton = document.getElementById('downloadButtonPdf');
            
            const originalText = downloadButton.innerHTML;
            downloadButton.disabled = true;
            downloadButton.innerHTML = 'Generando PDF...';

            try {
                if (typeof html2canvas === 'undefined' || typeof window.jspdf === 'undefined') {
                    throw new Error("Librer√≠as de PDF no est√°n cargadas.");
                }

                // 1. Obtener el canvas completo (incluyendo el buffer de seguridad)
                const canvas = await getReceiptCanvas();
                const imgData = canvas.toDataURL('image/png');
                
                // 2. Calcular las dimensiones de la imagen en base al tama√±o del canvas
                const canvasWidth = canvas.width;
                const canvasHeight = canvas.height;
                
                // 3. Obtener la altura real SIN el buffer para el c√°lculo del margen
                const originalReceiptHeight = receiptContainer.offsetHeight;
                const heightBuffer = 30; // El buffer usado en getReceiptCanvas (ACTUALIZADO)
                
                // Altura de contenido real en el canvas (excluyendo el espacio en blanco extra)
                const canvasHeightContent = canvas.height * (originalReceiptHeight / (originalReceiptHeight + heightBuffer));

                // 4. Definir dimensiones en mil√≠metros y m√°rgenes
                const margin = 10; // Margen uniforme de 10mm
                const pdfWidthMM = 210; // Usamos el ancho A4 como referencia para el escalado del ancho
                
                // 5. Calcular dimensiones de la imagen para que encaje en el ancho A4 con m√°rgenes
                const imgWidthMM = pdfWidthMM - (2 * margin); 
                
                // Usamos el ASPECT RATIO basado en la ALTURA REAL (sin buffer)
                const aspectRatio = canvasHeightContent / canvasWidth; 
                const imgHeightMM = imgWidthMM * aspectRatio;

                // 6. Crear el documento PDF con TAMA√ëO DE P√ÅGINA DIN√ÅMICO
                const { jsPDF } = window.jspdf;
                // La altura de la p√°gina ser√° la altura de la imagen real + 2*margin
                const pdf = new jsPDF('p', 'mm', [imgWidthMM + (2 * margin), imgHeightMM + (2 * margin)]);
                
                // 7. Agregar la imagen al PDF
                const xPos = margin; // Posici√≥n horizontal (margen izquierdo)
                const yPos = margin; // Posici√≥n vertical (margen superior)

                // A√±adimos la imagen, que ahora escalar√° solo la altura de contenido real.
                pdf.addImage(imgData, 'PNG', xPos, yPos, imgWidthMM, imgHeightMM);
                
                // 8. Definir nombre del archivo y guardar
                const kilos = document.getElementById('kilosInput').value || '0';
                const dateStr = document.getElementById('dateInput').value;
                const filename = `Comprobante_ICEKING_${kilos}Kg_${dateStr}.pdf`;
                
                pdf.save(filename);

            } catch (error) {
                console.error("Error al generar el PDF:", error);
                downloadButton.innerHTML = '‚ùå Error al Descargar PDF. Intente de Nuevo';
                setTimeout(() => {
                    downloadButton.innerHTML = originalText;
                    downloadButton.disabled = false;
                }, 3000);
                return; 
            } finally {
                if (downloadButton.innerHTML.indexOf('Error') === -1) {
                    downloadButton.innerHTML = originalText;
                    downloadButton.disabled = false;
                }
            }
        }
    </script>
</body>
</html>
